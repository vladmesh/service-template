.PHONY: setup lint format typecheck tests dev-start dev-stop prod-start prod-stop {% if 'backend' in modules %}makemigrations generate-from-spec validate-specs lint-controllers openapi typescript test-integration{% endif %} log tooling-tests

DOCKER_COMPOSE ?= docker compose
COMPOSE_BASE := -f infra/compose.base.yml
COMPOSE_DEV := $(COMPOSE_BASE) -f infra/compose.dev.yml
COMPOSE_PROD := $(COMPOSE_BASE) -f infra/compose.prod.yml
COMPOSE_TEST_INTEGRATION := -f infra/compose.tests.integration.yml
COMPOSE_ENV_INTEGRATION := COMPOSE_PROJECT_NAME=tests-integration

VENV := .venv/bin
PYTHON := $(VENV)/python

ifeq ($(word 1,$(MAKECMDGOALS)),log)
LOG_SERVICE := $(word 2,$(MAKECMDGOALS))
ifneq ($(LOG_SERVICE),)
$(eval $(LOG_SERVICE):;@:)
endif
endif

ifeq ($(word 1,$(MAKECMDGOALS)),tests)
TEST_TARGET := $(word 2,$(MAKECMDGOALS))
ifneq ($(TEST_TARGET),)
$(eval $(TEST_TARGET):;@:)
endif
endif

setup:
	uv venv
	uv pip install -e .framework/ ruff xenon
	@for svc in services/*/; do \
		[ -f "$$svc/pyproject.toml" ] || continue; \
		echo ">> Setting up $$svc"; \
		(cd "$$svc" && uv sync --frozen); \
	done

lint:
	$(VENV)/ruff check .
	$(VENV)/xenon --max-absolute B --max-modules A --max-average A --exclude '.framework/*,tests/*' .
	$(PYTHON) -c "from framework.spec.loader import validate_specs_cli; from framework.lib.env import get_repo_root; ok, msg = validate_specs_cli(get_repo_root()); print(msg); exit(0 if ok else 1)"
	$(PYTHON) -m framework.enforce_spec_compliance
	$(PYTHON) -c "from framework.lint.controller_sync import lint_controllers_cli; from framework.lib.env import get_repo_root; ok, msg = lint_controllers_cli(get_repo_root()); print(msg); exit(0 if ok else 1)"

lint-complexity:
	$(VENV)/xenon --max-absolute B --max-modules A --max-average A --exclude ".framework/*,tests/*" .
{% if 'backend' in modules %}
validate-specs:
	$(PYTHON) -c "from framework.spec.loader import validate_specs_cli; from framework.lib.env import get_repo_root; ok, msg = validate_specs_cli(get_repo_root()); print(msg); exit(0 if ok else 1)"

lint-specs:
	$(PYTHON) -m framework.enforce_spec_compliance
{% endif %}
format:
	$(VENV)/ruff format --exclude 'services/**/migrations' --exclude '.venv' --exclude '*/.venv' .
	$(VENV)/ruff check --fix --exclude 'services/**/migrations' --exclude '.venv' --exclude '*/.venv' .

typecheck:
	@for svc in services/*/; do \
		[ -f "$$svc/.venv/bin/mypy" ] || continue; \
		echo ">> Typechecking $$(basename $$svc)"; \
		PYTHONPATH=. MYPYPATH=. "$$svc/.venv/bin/mypy" "$$svc"; \
	done

tests:
	@target="$(TEST_TARGET)"; \
	if [ "$$target" = "tooling" ]; then $(MAKE) tooling-tests; exit 0; fi; \
	if [ -n "$$target" ] && [ "$$target" != "all" ]; then \
		svc="services/$$target"; \
		[ -d "$$svc/tests" ] || { echo "No tests for $$target"; exit 1; }; \
		echo ">> Testing $$target"; \
		PYTHONPATH=. "$$svc/.venv/bin/pytest" "$$svc/tests/" -q; \
		exit 0; \
	fi; \
	for svc in services/*/; do \
		[ -d "$$svc/tests" ] || continue; \
		echo ">> Testing $$(basename $$svc)"; \
		PYTHONPATH=. "$$svc/.venv/bin/pytest" "$$svc/tests/" -q; \
	done; \
	$(MAKE) tooling-tests
{% if 'backend' in modules %}
makemigrations:
	@if [ -z "$(name)" ]; then \
		echo "Usage: make makemigrations name=\"<description>\""; \
		exit 1; \
	fi
	$(DOCKER_COMPOSE) $(COMPOSE_DEV) run --rm backend alembic -c services/backend/migrations/alembic.ini revision --autogenerate -m "$(name)"

test-integration:
	$(COMPOSE_ENV_INTEGRATION) $(DOCKER_COMPOSE) $(COMPOSE_TEST_INTEGRATION) up --build --abort-on-container-exit --exit-code-from integration-tests
	$(COMPOSE_ENV_INTEGRATION) $(DOCKER_COMPOSE) $(COMPOSE_TEST_INTEGRATION) down --volumes --remove-orphans
{% endif %}
log:
	@service="$(if $(service),$(service),$(LOG_SERVICE))"; \
	if [ -z "$$service" ]; then \
		echo "Usage: make log <service_name>"; \
		echo "       make log service=\"<service_name>\""; \
		exit 1; \
	fi; \
	echo ">> Showing logs for $$service"; \
	$(DOCKER_COMPOSE) $(COMPOSE_DEV) logs --tail=100 $$service

dev-start:
	$(DOCKER_COMPOSE) $(COMPOSE_DEV) up -d --build

dev-stop:
	$(DOCKER_COMPOSE) $(COMPOSE_DEV) down --remove-orphans

prod-start:
	$(DOCKER_COMPOSE) $(COMPOSE_PROD) up -d --remove-orphans

prod-stop:
	$(DOCKER_COMPOSE) $(COMPOSE_PROD) down --remove-orphans

tooling-tests:
	@dirs=""; \
	[ -d tests/tooling ] && dirs="$$dirs tests/tooling"; \
	[ -d tests/unit ] && dirs="$$dirs tests/unit"; \
	if [ -z "$$dirs" ]; then \
		echo "No tooling/unit tests found, skipping"; \
	else \
		PYTHONPATH=.framework $(VENV)/pytest -q --cov=framework --cov-report=term-missing --cov-fail-under=70 $$dirs; \
	fi
{% if 'backend' in modules %}
generate-from-spec:
	$(PYTHON) -m framework.generate

lint-controllers:
	$(PYTHON) -c "from framework.lint.controller_sync import lint_controllers_cli; from framework.lib.env import get_repo_root; ok, msg = lint_controllers_cli(get_repo_root()); print(msg); exit(0 if ok else 1)"

openapi:
	$(PYTHON) -m framework.openapi.generator

typescript:
	$(PYTHON) -m framework.frontend.generator
{% endif %}
