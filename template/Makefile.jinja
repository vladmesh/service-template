.PHONY: lint format typecheck tests dev-start dev-stop prod-start prod-stop {% if 'backend' in modules %}makemigrations generate-from-spec validate-specs lint-controllers openapi typescript{% endif %} log tooling-tests

DOCKER_COMPOSE ?= docker compose
EXEC_MODE ?= docker
COMPOSE_BASE := -f infra/compose.base.yml
COMPOSE_DEV := $(COMPOSE_BASE) -f infra/compose.dev.yml
COMPOSE_PROD := $(COMPOSE_BASE) -f infra/compose.prod.yml
COMPOSE_TEST_UNIT := -f infra/compose.tests.unit.yml
COMPOSE_TEST_INTEGRATION := -f infra/compose.tests.integration.yml
COMPOSE_ENV_UNIT := COMPOSE_PROJECT_NAME=tests-unit
COMPOSE_ENV_TOOLING := COMPOSE_PROJECT_NAME=tooling HOST_UID=$$(id -u) HOST_GID=$$(id -g)
COMPOSE_ENV_INTEGRATION := COMPOSE_PROJECT_NAME=tests-integration

ifeq ($(EXEC_MODE),native)
RUN_TOOLING := PYTHONPATH=.framework
PYTHON_TOOLING := PYTHONPATH=.framework python3
else
RUN_TOOLING := $(COMPOSE_ENV_TOOLING) $(DOCKER_COMPOSE) $(COMPOSE_TEST_UNIT) run --build --rm tooling
PYTHON_TOOLING := $(RUN_TOOLING) python
endif

ifeq ($(word 1,$(MAKECMDGOALS)),log)
LOG_SERVICE := $(word 2,$(MAKECMDGOALS))
ifneq ($(LOG_SERVICE),)
$(eval $(LOG_SERVICE):;@:)
endif
endif

ifeq ($(word 1,$(MAKECMDGOALS)),tests)
TEST_TARGET := $(word 2,$(MAKECMDGOALS))
ifneq ($(TEST_TARGET),)
$(eval $(TEST_TARGET):;@:)
endif
endif

lint:
{% if 'backend' in modules -%}
	$(RUN_TOOLING) sh -c "ruff check . && xenon --max-absolute B --max-modules A --max-average A --exclude '.framework/*,tests/*' . && python -c 'from framework.spec.loader import validate_specs_cli; from framework.lib.env import get_repo_root; ok, msg = validate_specs_cli(get_repo_root()); print(msg); exit(0 if ok else 1)' && python -m framework.enforce_spec_compliance && python -c 'from framework.lint.controller_sync import lint_controllers_cli; from framework.lib.env import get_repo_root; ok, msg = lint_controllers_cli(get_repo_root()); print(msg); exit(0 if ok else 1)'"
{% else -%}
	$(RUN_TOOLING) sh -c "ruff check . && xenon --max-absolute B --max-modules A --max-average A --exclude '.framework/*,tests/*' . && python -m framework.enforce_spec_compliance"
{% endif %}
lint-complexity:
	$(RUN_TOOLING) xenon --max-absolute B --max-modules A --max-average A --exclude ".framework/*,tests/*" .
{% if 'backend' in modules %}
validate-specs:
	$(PYTHON_TOOLING) -c "from framework.spec.loader import validate_specs_cli; from framework.lib.env import get_repo_root; ok, msg = validate_specs_cli(get_repo_root()); print(msg); exit(0 if ok else 1)"

lint-specs:
	$(PYTHON_TOOLING) -m framework.enforce_spec_compliance
{% endif %}
format:
	$(RUN_TOOLING) sh -c "ruff format --exclude 'services/**/migrations' --exclude '.venv' . && ruff check --fix --exclude 'services/**/migrations' --exclude '.venv' ."

typecheck:
	$(RUN_TOOLING) mypy tests
	@set -eu; \
	tmp_file="$$(mktemp)"; \
	trap 'rm -f "$$tmp_file"' EXIT; \
	$(PYTHON_TOOLING) -m framework.service_info tests > "$$tmp_file"; \
	grep -E '^[[:alnum:]_]+ ' "$$tmp_file" > "$$tmp_file.filtered"; \
	mv "$$tmp_file.filtered" "$$tmp_file"; \
	while read -r suite compose_project compose_file compose_service mode; do \
		if [ "$$mode" = "run" ]; then \
			echo ">> Typechecking $$suite ($$compose_service)"; \
			COMPOSE_PROJECT_NAME=$$compose_project $(DOCKER_COMPOSE) -f $$compose_file run --build --rm $$compose_service poetry run mypy .; \
		fi; \
	done < "$$tmp_file"

tests:
	@set -eu; \
	target="$(if $(suite),$(suite),$(if $(service),$(service),$(TEST_TARGET)))"; \
	if [ "$$target" = "tooling" ]; then \
		$(MAKE) tooling-tests; \
		exit 0; \
	fi; \
	run_tooling="0"; \
	if [ -z "$$target" ] || [ "$$target" = "all" ]; then \
		run_tooling="1"; \
	fi; \
	tmp_file="$$(mktemp)"; \
	trap 'rm -f "$$tmp_file"' EXIT; \
		if [ -z "$$target" ] || [ "$$target" = "all" ]; then \
			$(PYTHON_TOOLING) -m framework.service_info tests > "$$tmp_file"; \
		else \
				$(PYTHON_TOOLING) -m framework.service_info tests --suite "$$target" > "$$tmp_file"; \
		fi; \
	grep -E '^[[:alnum:]_]+ ' "$$tmp_file" > "$$tmp_file.filtered"; \
	mv "$$tmp_file.filtered" "$$tmp_file"; \
	while read -r suite compose_project compose_file compose_service mode; do \
		[ -z "$$suite" ] && continue; \
		echo ">> Running $$suite tests ($(basename $$compose_file))"; \
		if [ "$(EXEC_MODE)" = "native" ]; then \
			if [ "$$suite" = "backend" ]; then \
				cd services/backend && poetry run pytest tests/ -q; \
				cd ../..; \
			fi; \
		else \
			if [ "$$mode" = "up" ]; then \
				COMPOSE_PROJECT_NAME=$$compose_project $(DOCKER_COMPOSE) -f $$compose_file up --build --abort-on-container-exit --exit-code-from $$compose_service $$compose_service; \
				status=$$?; \
				COMPOSE_PROJECT_NAME=$$compose_project $(DOCKER_COMPOSE) -f $$compose_file down --volumes --remove-orphans; \
				if [ $$status -ne 0 ]; then exit $$status; fi; \
			else \
				COMPOSE_PROJECT_NAME=$$compose_project $(DOCKER_COMPOSE) -f $$compose_file run --build --rm $$compose_service; \
			fi; \
		fi; \
	done < "$$tmp_file"; \
	if [ "$$run_tooling" = "1" ]; then \
		$(MAKE) tooling-tests; \
	fi
{% if 'backend' in modules %}
makemigrations:
	@if [ -z "$(name)" ]; then \
		echo "Usage: make makemigrations name=\"<description>\""; \
		exit 1; \
	fi
	$(DOCKER_COMPOSE) $(COMPOSE_DEV) run --rm backend alembic -c services/backend/migrations/alembic.ini revision --autogenerate -m "$(name)"
{% endif %}
log:
	@service="$(if $(service),$(service),$(LOG_SERVICE))"; \
	if [ -z "$$service" ]; then \
		echo "Usage: make log <service_name>"; \
		echo "       make log service=\"<service_name>\""; \
		exit 1; \
	fi; \
	tmp_file="$$(mktemp)"; \
	trap 'rm -f "$$tmp_file"' EXIT; \
		$(PYTHON_TOOLING) -m framework.service_info logs --service $$service > "$$tmp_file"; \
	target_line="$$(grep -E '^[[:alnum:]_]+ ' "$$tmp_file" | head -n 1)"; \
	if [ -z "$$target_line" ]; then \
		exit 1; \
	fi; \
	set -- $$target_line; \
	compose_service="$$2"; \
	echo ">> Showing logs for $$service (compose service: $$compose_service)"; \
	$(DOCKER_COMPOSE) $(COMPOSE_DEV) logs --tail=100 $$compose_service

dev-start:
	$(DOCKER_COMPOSE) $(COMPOSE_DEV) up -d --build

dev-stop:
	$(DOCKER_COMPOSE) $(COMPOSE_DEV) down --remove-orphans

prod-start:
	$(DOCKER_COMPOSE) $(COMPOSE_PROD) up -d --remove-orphans

prod-stop:
	$(DOCKER_COMPOSE) $(COMPOSE_PROD) down --remove-orphans

tooling-tests:
	@dirs=""; \
	[ -d tests/tooling ] && dirs="$$dirs tests/tooling"; \
	[ -d tests/unit ] && dirs="$$dirs tests/unit"; \
	if [ -z "$$dirs" ]; then \
		echo "No tooling/unit tests found, skipping"; \
	else \
		if [ "$(EXEC_MODE)" = "native" ]; then \
			PYTHONPATH=.framework pytest -q --cov=framework --cov-report=term-missing --cov-fail-under=70 $$dirs; \
		else \
			$(RUN_TOOLING) pytest -q --cov=framework --cov-report=term-missing --cov-fail-under=70 $$dirs; \
		fi; \
	fi
{% if 'backend' in modules %}
generate-from-spec:
	$(PYTHON_TOOLING) -m framework.generate

lint-controllers:
	$(PYTHON_TOOLING) -c "from framework.lint.controller_sync import lint_controllers_cli; from framework.lib.env import get_repo_root; ok, msg = lint_controllers_cli(get_repo_root()); print(msg); exit(0 if ok else 1)"

openapi:
	$(PYTHON_TOOLING) -m framework.openapi.generator

typescript:
	$(PYTHON_TOOLING) -m framework.frontend.generator
{% endif %}
