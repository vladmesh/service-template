#!/usr/bin/env bash
# Pre-commit hook for PRODUCT project (generated from service-template)
# Formats code before commit
set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "${REPO_ROOT}"

# Check if Docker Compose is available and working
if command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1 && docker info >/dev/null 2>&1; then
    echo "[pre-commit] Running make format (Docker)..."
    make format
else
    echo "[pre-commit] Docker not available, running ruff directly..."
    if command -v ruff >/dev/null 2>&1; then
        ruff format --exclude 'services/**/migrations' --exclude '.venv' .
        ruff check --fix --exclude 'services/**/migrations' --exclude '.venv' . || true
    else
        echo "[pre-commit] WARNING: Neither Docker nor ruff available, skipping format"
    fi
fi

echo "[pre-commit] Staging formatting changes..."
git add -A
