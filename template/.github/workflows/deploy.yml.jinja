name: Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Copy compose files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: {% raw %}${{ secrets.DEPLOY_HOST }}{% endraw %}
          username: {% raw %}${{ secrets.DEPLOY_USER }}{% endraw %}
          key: {% raw %}${{ secrets.DEPLOY_SSH_KEY }}{% endraw %}
          source: "infra/compose.base.yml,infra/compose.prod.yml"
          target: {% raw %}/opt/services/${{ secrets.PROJECT_NAME }}{% endraw %}
          overwrite: true

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: {% raw %}${{ secrets.DEPLOY_HOST }}{% endraw %}
          username: {% raw %}${{ secrets.DEPLOY_USER }}{% endraw %}
          key: {% raw %}${{ secrets.DEPLOY_SSH_KEY }}{% endraw %}
          envs: DOTENV_B64,REGISTRY_URL,REGISTRY_USER,REGISTRY_PASSWORD
          script: |
            set -euo pipefail
            PROJECT_DIR="/opt/services/{% raw %}${{ secrets.PROJECT_NAME }}{% endraw %}"
            mkdir -p "$PROJECT_DIR/infra"

            # Backup previous .env before overwriting
            cp "$PROJECT_DIR/.env" "$PROJECT_DIR/.env.bak" 2>/dev/null || true

            # Decode .env from base64 DOTENV secret
            printf '%s' "$DOTENV_B64" | base64 -d > "$PROJECT_DIR/.env"

            # Ensure .env.prod exists (compose.prod.yml references it for overrides)
            touch "$PROJECT_DIR/infra/.env.prod"

            # Open firewall port
            ufw allow {% raw %}${{ secrets.DEPLOY_PORT }}{% endraw %}/tcp || true

            # Log in to Docker registry
            echo "$REGISTRY_PASSWORD" | docker login "$REGISTRY_URL" -u "$REGISTRY_USER" --password-stdin

            # Pull and deploy
            cd "$PROJECT_DIR/infra"
            docker compose --env-file ../.env -f compose.base.yml -f compose.prod.yml pull
            docker compose --env-file ../.env -f compose.base.yml -f compose.prod.yml up -d --remove-orphans

            # Health check: wait and verify all containers are running
            sleep 15
            docker compose -f compose.base.yml -f compose.prod.yml ps --format json | python3 -c "
            import sys, json
            raw = sys.stdin.read().strip()
            if not raw:
                print('No containers found'); sys.exit(1)
            try:
                containers = json.loads(raw)
            except json.JSONDecodeError:
                containers = [json.loads(line) for line in raw.splitlines() if line.strip()]
            if not isinstance(containers, list):
                containers = [containers]
            failed = [c['Name'] for c in containers if c.get('State') != 'running']
            if failed:
                print(f'FAILED: {failed}'); sys.exit(1)
            print(f'All {len(containers)} containers running')
            "
        env:
          DOTENV_B64: {% raw %}${{ secrets.DOTENV }}{% endraw %}
          REGISTRY_URL: {% raw %}${{ secrets.REGISTRY_URL }}{% endraw %}
          REGISTRY_USER: {% raw %}${{ secrets.REGISTRY_USER }}{% endraw %}
          REGISTRY_PASSWORD: {% raw %}${{ secrets.REGISTRY_PASSWORD }}{% endraw %}
