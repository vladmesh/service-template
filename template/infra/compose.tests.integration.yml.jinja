services:
  backend:
    extends:
      file: compose.base.yml
      service: backend
    build:
      context: ..
      dockerfile: services/backend/Dockerfile
      args:
        INSTALL_DEV_DEPS: "true"
    env_file:
      - ../.env
      - ./.env.test
    environment:
      PYTHONPATH: /workspace
      ASYNC_DATABASE_URL: postgresql+asyncpg://postgres:${POSTGRES_PASSWORD:-postgres}@db:5432/${POSTGRES_DB:-service_template}
    volumes:
      - ../:/workspace:delegated
    working_dir: /workspace
    stop_grace_period: 2s

  db:
    extends:
      file: compose.base.yml
      service: db
    volumes:
      - type: tmpfs
        target: /var/lib/postgresql/data

  integration-tests:
    image: ${BACKEND_IMAGE:-{{ project_slug }}-backend:latest}
    build:
      context: ..
      dockerfile: services/backend/Dockerfile
      args:
        INSTALL_DEV_DEPS: "true"
    command: pytest -q tests/integration
    working_dir: /workspace
    volumes:
      - ../:/workspace:delegated
    env_file:
      - ../.env
      - ./.env.test
    environment:
      PYTHONPATH: /workspace
    depends_on:
      backend:
        condition: service_started
      db:
        condition: service_healthy

