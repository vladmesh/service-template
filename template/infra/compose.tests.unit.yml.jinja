services:
{% if 'backend' in modules %}
  backend-tests-unit:
    image: ${BACKEND_IMAGE:-{{ project_slug }}-backend:latest}
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    build:
      context: ..
      dockerfile: services/backend/Dockerfile
      args:
        INSTALL_DEV_DEPS: "true"
    command: >-
      pytest -q --cov=services/backend/src
      --cov-report=term-missing --cov-fail-under=70
      services/backend/tests/unit
    working_dir: /app
    env_file:
      - ../.env
    environment:
      PYTHONPATH: /app
      ENVIRONMENT: test
      APP_ENV: test
      DATABASE_URL: sqlite+pysqlite:////tmp/backend_tests/test.db
      REDIS_URL: redis://localhost:6379
{% endif %}

  tooling:
    image: ${TOOLING_IMAGE:-{{ project_slug }}-tooling:latest}
    build:
      context: ..
      dockerfile: tooling/Dockerfile
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    working_dir: /workspace
    volumes:
      - ..:/workspace:delegated
    env_file:
      - .env
    environment:
      PYTHONPATH: /workspace/.framework
