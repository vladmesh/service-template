# Agents Playbook

Точка входа для AI-агентов, работающих с этим проектом.

## С чего начать

1. **`TASK.md`** — описание задачи проекта
2. **`ARCHITECTURE.md`** — архитектура и spec-first подход
3. **`CONTRIBUTING.md`** — правила кодирования (enforced CI)
4. **`services.yml`** — реестр всех сервисов

## Команды

Все операции выполняются через `make`. Никогда не запускайте инструменты напрямую.

| Команда | Назначение |
|---------|-----------|
| `make setup` | Bootstrap: venvs, codegen, git hooks (один раз) |
| `make lint` | Все линтеры (ruff, xenon, spec validation, compliance) |
| `make format` | Авто-форматирование (ruff) |
| `make typecheck` | mypy по сервисам |
| `make tests` | Все тесты |
| `make tests <service>` | Тесты одного сервиса |
| `make dev-start` / `make dev-stop` | Docker dev-окружение |
| `make prod-start` / `make prod-stop` | Docker prod-окружение |
| `make log <service>` | Логи контейнера |
{%- if 'backend' in modules %}
| `make generate-from-spec` | Перегенерировать код из YAML-спеков |
| `make validate-specs` | Проверить YAML-спеки до генерации |
| `make lint-controllers` | Проверить синхронизацию контроллеров с протоколами |
| `make makemigrations name="..."` | Создать Alembic-миграцию |
| `make openapi` | Экспорт OpenAPI JSON |
| `make typescript` | Генерация TypeScript типов |
| `make test-integration` | Интеграционные тесты в Docker |
{%- endif %}

## Environment Variables — строгое правило

**НИКОГДА** не используйте значения по умолчанию в `os.getenv("VAR", "default")`.
Если переменная отсутствует — приложение **ДОЛЖНО** упасть немедленно:

```python
value = os.getenv("REQUIRED_VAR")
if not value:
    raise RuntimeError("REQUIRED_VAR is not set; please add it to your environment variables")
```

Все переменные документированы в `.env.example`.

## Read-Only зоны

Не редактируйте вручную:
{%- if 'backend' in modules %}
- `shared/generated/` — перегенерируется через `make generate-from-spec`
- `services/*/src/generated/` — перегенерируется по спекам сервиса
{%- endif %}
- `.framework/` — внутренности фреймворка
{%- if 'tg_bot' in modules or 'notifications' in modules %}

## Брокер событий — паттерн get_broker()

`shared/generated/events.py` предоставляет lazy-брокер через `get_broker()`.
**Не** импортируйте `broker` как атрибут модуля.

**Подключение (FastAPI lifespan):**
```python
from shared.generated.events import get_broker

@asynccontextmanager
async def lifespan(app: FastAPI):
    broker = get_broker()
    await broker.connect()
    yield
    await broker.close()
```

**Публикация событий:**
```python
from shared.generated.events import publish_command_received
from shared.generated.schemas import CommandReceived

event = CommandReceived(...)
await publish_command_received(event)  # broker должен быть подключён
```

**FastStream workers** (`python-faststream`) создают `RedisBroker` напрямую в `main()` и передают в `create_event_adapter()`. Lifecycle управляется через `FastStream(broker).run()`.
{%- endif %}

## Документация сервисов
{%- if 'backend' in modules %}
- **Backend API:** `services/backend/AGENTS.md`
{%- endif %}
{%- if 'tg_bot' in modules %}
- **Telegram Bot:** `services/tg_bot/AGENTS.md`
{%- endif %}
{%- if 'notifications' in modules %}
- **Notifications Worker:** `services/notifications_worker/AGENTS.md`
{%- endif %}
{%- if 'frontend' in modules %}
- **Frontend:** `services/frontend/AGENTS.md`
{%- endif %}
