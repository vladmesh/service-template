"""Pytest configuration for {{ project_name }}.

This file contains shared fixtures and configuration for all tests.
"""

from collections.abc import Generator
import os

import pytest
{%- if 'backend' in modules %}

try:
    from sqlalchemy import create_engine
    from sqlalchemy.orm import Session, sessionmaker

    from shared.shared.generated.database import Base

    HAS_SQLALCHEMY = True
except ImportError:
    HAS_SQLALCHEMY = False
{%- endif %}
{%- if 'tg_bot' in modules or 'notifications' in modules %}

try:
    from redis import Redis

    HAS_REDIS = True
except ImportError:
    HAS_REDIS = False
{%- endif %}

{% if 'backend' in modules %}
if HAS_SQLALCHEMY:

    @pytest.fixture(scope="session")
    def test_db_url() -> str:
        """Get test database URL from environment."""
        return os.getenv(
            "TEST_DATABASE_URL",
            "postgresql://postgres:postgres@localhost:5432/test_db",
        )

    @pytest.fixture(scope="session")
    def test_engine(test_db_url: str):
        """Create test database engine."""
        engine = create_engine(test_db_url)
        Base.metadata.create_all(bind=engine)
        yield engine
        Base.metadata.drop_all(bind=engine)
        engine.dispose()

    @pytest.fixture
    def db_session(test_engine) -> Generator[Session, None, None]:
        """Create a test database session with automatic rollback."""
        SessionLocal = sessionmaker(bind=test_engine)
        session = SessionLocal()
        try:
            yield session
        finally:
            session.rollback()
            session.close()
{% endif %}

{% if 'tg_bot' in modules or 'notifications' in modules %}
if HAS_REDIS:

    @pytest.fixture(scope="session")
    def test_redis_url() -> str:
        """Get test Redis URL from environment."""
        return os.getenv("TEST_REDIS_URL", "redis://localhost:6379/15")

    @pytest.fixture
    def redis_client(test_redis_url: str) -> Generator[Redis, None, None]:
        """Create a test Redis client with automatic cleanup."""
        client = Redis.from_url(test_redis_url, decode_responses=True)
        yield client
        client.flushdb()
        client.close()
{% endif %}


# Add your custom fixtures below
