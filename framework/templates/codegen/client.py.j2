# AUTO-GENERATED BY SERVICE-TEMPLATE - DO NOT EDIT
"""
Typed HTTP client for {{ provider }} service.
"""
from __future__ import annotations

import os
from typing import Any

import httpx

{% if imports %}
from shared.generated.schemas import (
    {% for model in imports|sort %}
    {{ model }},
    {% endfor %}
)
{% endif %}


class {{ provider_capitalized }}Client:
    """Async HTTP client for {{ provider }} service API.
    
    Usage:
        async with {{ provider_capitalized }}Client() as client:
            result = await client.create_user(payload)
    """
    
    def __init__(
        self,
        base_url: str | None = None,
        timeout: float = 10.0,
    ) -> None:
        """Initialize client.
        
        Args:
            base_url: Base URL for the service. Defaults to {{ provider_upper }}_API_URL env var.
            timeout: Request timeout in seconds.
        """
        self.base_url = base_url or os.getenv("{{ provider_upper }}_API_URL", "")
        if not self.base_url:
            raise ValueError(
                "{{ provider_capitalized }}Client requires base_url or "
                "{{ provider_upper }}_API_URL environment variable"
            )
        self.timeout = timeout
        self._client: httpx.AsyncClient | None = None

    async def __aenter__(self) -> "{{ provider_capitalized }}Client":
        """Enter async context manager."""
        self._client = httpx.AsyncClient(
            base_url=self.base_url,
            timeout=self.timeout,
        )
        return self

    async def __aexit__(self, *args: Any) -> None:
        """Exit async context manager."""
        if self._client:
            await self._client.aclose()
            self._client = None

    def _ensure_client(self) -> httpx.AsyncClient:
        """Ensure client is initialized."""
        if self._client is None:
            raise RuntimeError(
                "{{ provider_capitalized }}Client must be used as async context manager: "
                "async with {{ provider_capitalized }}Client() as client: ..."
            )
        return self._client

    {% for domain in domains %}
    # --- {{ domain.name }} operations ---
    {% for op in domain.operations %}

    async def {{ op.name }}(
        self,
        {% for param in op.params %}
        {{ param.name }}: {{ param.type }},
        {% endfor %}
        {% if op.input_model %}
        payload: {{ op.input_model }},
        {% endif %}
    ) -> {{ op.return_type }}:
        """Call {{ op.name }} on {{ provider }} service."""
        client = self._ensure_client()
        
        {% if op.params %}
        path = "{{ domain.prefix }}{{ op.path }}".format(
            {% for param in op.params %}
            {{ param.name }}={{ param.name }},
            {% endfor %}
        )
        {% else %}
        path = "{{ domain.prefix }}{{ op.path }}"
        {% endif %}
        
        response = await client.{{ op.http_method }}(
            path,
            {% if op.input_model %}
            json=payload.model_dump(mode="json"),
            {% endif %}
        )
        response.raise_for_status()
        {% if op.output_model %}
        return {{ op.output_model }}.model_validate(response.json())
        {% endif %}
    {% endfor %}
    {% endfor %}
