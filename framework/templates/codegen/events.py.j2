# Generated by framework - DO NOT EDIT
import os
from typing import Any

from faststream.redis import RedisBroker
from faststream.redis.parser import BinaryMessageFormatV1

{% if imports %}
from shared.generated.schemas import {{ imports | join(', ') }}
{% endif %}

_broker: RedisBroker | None = None


def get_broker() -> RedisBroker:
    """Get or create the Redis broker (lazy initialization)."""
    global _broker
    if _broker is None:
        redis_url = os.getenv("REDIS_URL")
        if not redis_url:
            raise RuntimeError("REDIS_URL is not set; please add it to your environment variables")
        _broker = RedisBroker(redis_url, message_format=BinaryMessageFormatV1)
    return _broker

{% for pub in publishers %}
_pub_{{ pub.name }}: Any = None


async def publish_{{ pub.name }}(message: {{ pub.message_model }}) -> Any:
    """Publish {{ pub.message_model }} to channel '{{ pub.name }}'."""
    global _pub_{{ pub.name }}
    if _pub_{{ pub.name }} is None:
        _pub_{{ pub.name }} = get_broker().publisher("{{ pub.name }}")
    return await _pub_{{ pub.name }}.publish(message)
{% endfor %}
