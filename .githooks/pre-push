#!/usr/bin/env bash
# Pre-push hook for service-template FRAMEWORK repository
# This hook verifies framework code quality before pushing
# Only runs checks relevant to the changed files
set -euo pipefail

remote_name="${1-}"
remote_url="${2-}"

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "${REPO_ROOT}"

echo "[pre-push] Verifying push to ${remote_name:-unknown} (${remote_url:-})..."

export DOCKER_BUILDKIT=1

# Determine what files changed compared to what's already pushed
# Falls back to origin/main for new branches
changed_files=$(git diff --name-only @{push}...HEAD 2>/dev/null || git diff --name-only origin/main...HEAD 2>/dev/null || git diff --name-only HEAD~1)

if [ -z "$changed_files" ]; then
  echo "[pre-push] No changes detected, skipping checks"
  exit 0
fi

echo "[pre-push] Changed files:"
echo "$changed_files" | head -20
[ "$(echo "$changed_files" | wc -l)" -gt 20 ] && echo "  ... and more"

run_check_sync=false
run_lint=false
run_test=false
run_test_copier=false

# Analyze what changed
if echo "$changed_files" | grep -qE '^framework/'; then
  run_check_sync=true
  run_lint=true
  run_test=true
fi

if echo "$changed_files" | grep -qE '^tests/'; then
  run_lint=true
  run_test=true
fi

if echo "$changed_files" | grep -qE '^(template/|copier\.yml$)'; then
  run_test_copier=true
fi

# Makefile/infra/scripts affect everything
if echo "$changed_files" | grep -qE '^(Makefile$|infra/|scripts/)'; then
  run_check_sync=true
  run_lint=true
  run_test=true
  run_test_copier=true
fi

# .github workflows should trigger full check
if echo "$changed_files" | grep -qE '^\.github/'; then
  run_check_sync=true
  run_lint=true
  run_test=true
  run_test_copier=true
fi

# Execute only necessary checks
checks_run=0

if $run_check_sync; then
  echo ""
  echo "[pre-push] Checking framework synchronization..."
  make check-sync
  ((checks_run++)) || true
fi

if $run_lint; then
  echo ""
  echo "[pre-push] Running linters..."
  make lint
  ((checks_run++)) || true
fi

if $run_test; then
  echo ""
  echo "[pre-push] Running framework tests..."
  make test
  ((checks_run++)) || true
fi

# TODO: re-enable after copier tests are updated for venv/lazy-broker changes
# if $run_test_copier; then
#   echo ""
#   echo "[pre-push] Running copier tests..."
#   make test-copier
#   ((checks_run++)) || true
# fi

if [ "$checks_run" -eq 0 ]; then
  echo "[pre-push] No relevant checks for changed files (docs only?), skipping"
fi

echo ""
echo "[pre-push] âœ… All checks passed!"
