#!/usr/bin/env bash
set -euo pipefail

remote_name="${1-}"
remote_url="${2-}"

should_run=0
while read -r local_ref local_sha remote_ref remote_sha; do
  if [[ "${local_ref}" == "refs/heads/main" ]] || [[ "${remote_ref}" == "refs/heads/main" ]]; then
    should_run=1
  fi
done

if [[ "${should_run}" -eq 0 ]]; then
  exit 0
fi

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "${REPO_ROOT}"

echo "[pre-push] Verifying push to main (${remote_name:-unknown} ${remote_url:-})..."
make sync-services
make lint
make tests
