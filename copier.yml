_min_copier_version: "9.0.0"
_answers_file: .copier-answers.yml
_templates_suffix: .jinja
_subdirectory: template

# Files to exclude from template (template development files)
_exclude:
  - .git
  - .git/**
  - __pycache__
  - "**/__pycache__"
  - "*.pyc"
  - .pytest_cache
  - "**/.pytest_cache"
  - .mypy_cache
  - "**/.mypy_cache"
  - .ruff_cache
  - "**/.ruff_cache"
  - .venv
  - "**/.venv"
  - node_modules
  - "**/node_modules"
  - "*.egg-info"
  - dist
  - build
  - "**/*.egg-info"
  - .coverage
  - "**/.coverage"
  # Always exclude test_service (it's for template development only)
  - services/test_service
  - services/test_service/**


# Files to skip if they already exist (preserve user modifications on update)
_skip_if_exists:
  - .env
  - .env.example
  - infra/.env
  - shared/spec/models.yaml
  - shared/spec/events.yaml
  - "services/*/src/app/**"
  - "services/*/src/controllers/**"

# ============================================================================
# Project Metadata
# ============================================================================

project_name:
  type: str
  help: "Project name (lowercase, hyphens allowed, e.g. 'my-awesome-api')"
  validator: "{% if not project_name | regex_search('^[a-z][a-z0-9-]*$') %}Project name must be lowercase, start with a letter, and contain only letters, numbers, and hyphens{% endif %}"

project_slug:
  type: str
  default: "{{ project_name | replace('-', '_') }}"
  when: false  # Computed, not asked

project_description:
  type: str
  help: "Short project description"
  default: "A microservice project built with service-template framework"

task_description:
  type: str
  help: "Detailed task description for the developer (what to build)"
  default: ""

author_name:
  type: str
  help: "Author name"
  default: "Developer"

author_email:
  type: str
  help: "Author email"
  default: "dev@example.com"

# ============================================================================
# Module Selection
# ============================================================================

modules:
  type: str
  help: |
    Modules to include (comma-separated).
    Available: backend, tg_bot, notifications, frontend
    Example: backend,tg_bot
    Note: at least one module must be selected.
  default: "backend"
  validator: "{% if not modules or modules.strip() == '' %}At least one module must be selected{% endif %}"

# Computed list for easier iteration
modules_list:
  type: str
  default: "{{ modules.split(',') | map('trim') | list }}"
  when: false

# ============================================================================
# Technical Options
# ============================================================================

python_version:
  type: str
  help: "Python version"
  default: "3.12"
  choices:
    - "3.11"
    - "3.12"

node_version:
  type: str
  help: "Node.js version (for frontend)"
  default: "20"
  when: "{{ 'frontend' in modules }}"

# ============================================================================
# Tasks - Clean up unselected modules after copy
# ============================================================================
# NOTE: When running copier via Docker, pass -e HOST_UID=$(id -u) -e HOST_GID=$(id -g)
# to fix file ownership. The last task will chown all files to the host user.
# NOTE: No ruff/formatting here - templates should produce clean output by design,
# and any formatting should be done in containers via `make format`.
_tasks:
  - "{% if 'tg_bot' not in modules %}rm -rf services/tg_bot{% endif %}"
  - "{% if 'notifications' not in modules %}rm -rf services/notifications_worker{% endif %}"
  - "{% if 'backend' not in modules %}rm -rf services/backend{% endif %}"
  - "{% if 'frontend' not in modules %}rm -rf services/frontend{% endif %}"
  - "{% if 'backend' not in modules %}rm -rf shared/spec shared/shared/generated shared/shared/http_client.py{% endif %}"
  - "{% if 'backend' not in modules %}rm -rf services/*/spec{% endif %}"
  # Configure git to use .githooks directory for hooks
  - "chmod +x .githooks/* 2>/dev/null || true"
  - "git config core.hooksPath .githooks 2>/dev/null || true"
  # Regenerate code from specs so scaffolded files match what CI produces
  - "PYTHONPATH=.framework python3 -m framework.generate"
  # Fix file permissions if running as root in Docker
  - "if [ -n \"$HOST_UID\" ] && [ -n \"$HOST_GID\" ]; then chown -R $HOST_UID:$HOST_GID .; fi"

